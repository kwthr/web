---
title: 'Stylify CSS: primeros paquetes CSS de utilidades automatizados que se dividen en capas CSS en Astro.build'
image: '/images/blog/stylify-astro-bundles/header.jpg'
ogImage: '/images/blog/stylify-astro-bundles/og-image.jpg'
author: 'Vladim√≠r Mach√°ƒçek'
annotation: 'Stylify CSS: primeros paquetes CSS de utilidad automatizados que se dividen en capas CSS en Astro.build'
createdAt: 'December 11, 2022'
---

Utility-First CSS de primera utilidad pueden ser muy peque√±os. Pero, ¬øy si pudi√©ramos hacerlos a√∫n m√°s peque√±os? ¬øDividirlos para cada p√°gina/dise√±o, por ejemplo? Es posible que algunas p√°ginas no tengan estilos de otra p√°gina. Aprende a dividir paquetes de CSS en Astro. construir autom√°ticamente usando Stylify CSS.

## Video Guide

<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/OYJn23w8fqI" class="width:100%" frameborder="0" loading="lazy" fetchpriority="low" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

## La introducci√≥n de Stylify CSS
[Stylify](/) es una biblioteca que utiliza selectores similares a CSS para generar un CSS de primera utilidad optimizado en funci√≥n de lo que escribe.

- ‚úÖ Selectores tipo CSS
- ‚úÖ Sin marco para estudiar
- ‚úÖ Menos tiempo dedicado a los documentos
- ‚úÖ CSS destrozado y extremadamente peque√±o
- ‚úÖ No se necesita purga de CSS
- ‚úÖ Componentes, Variables, Selectores personalizados
- ‚úÖ Puede generar m√∫ltiples paquetes CSS

Tambi√©n tenemos una p√°gina sobre [¬°qu√© problemas resuelve Stylify CSS y por qu√© deber√≠a probarlo!](/es/docs/get-started/why-stylify-css)

## Motivaci√≥n
Cada paquete puede contener solo el CSS necesario. Esto significa casi cero CSS no utilizado y, en producci√≥n, se puede modificar y minimizar, por lo que el CSS es a√∫n m√°s peque√±o (m√°s informaci√≥n a continuaci√≥n).
![Stylify Ejemplo](/images/blog/stylify-astro-bundles/preview.png)

## El c√≥digo
Bien, primero el c√≥digo, luego la explicaci√≥n. Aunque el c√≥digo puede parecer complicado, en realidad es bastante simple:

```javascript
import stylify from '@stylify/astro';
import { hooks } from '@stylify/bundler';
import fastGlob from 'fast-glob';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

const pagesDir = 'src/pages';
const layoutsDir = 'src/layouts';
const stylesDir = 'src/styles';

/** @type { import('@stylify/bundler').BundlerConfigInterface[]} */
const stylifyBundles = [];
const layoutCssLayerName = 'layout';
const pageCssLayerName = 'page';

const getFileCssLayerName = (filePath) =>
	filePath.includes('/pages/') ? pageCssLayerName : layoutCssLayerName;

const getOutputFileName = (file) => {
	const parsedFile = path.parse(file);
	const fileName = parsedFile.name.toLowerCase();
	const dirNameCleanupRegExp = new RegExp(`${pagesDir}|${layoutsDir}|\\W`, 'g');
	const dir = parsedFile.dir.replace(dirNameCleanupRegExp, '');
	return `${dir.length ? `${dir}-` : ''}${fileName}.css`;
};

const createBundle = (file) => {
	const fileName = path.parse(file).name;
	const fileCssLayerName = getFileCssLayerName(file);

	return {
		outputFile: `${stylesDir}/${fileCssLayerName}/${getOutputFileName(file)}`,
		files: [file],
		cssLayer: fileCssLayerName,
	};
};

const createBundles = (files) => {
	for (const file of files) {
		stylifyBundles.push(createBundle(file));
	}
};

// 1. Asignar archivos en dise√±os/p√°ginas y crear paquetes
createBundles(fastGlob.sync(`${pagesDir}/**/*.astro`));
createBundles(fastGlob.sync(`${layoutsDir}/**/*.astro`));

// 2. Inic Stylify Astro Integraton
const stylifyIntegration = stylify({
	bundler: {
		id: 'astro',
		// Set CSS @layers order
		cssLayersOrder: {
			// Order will be @layer layout,page;
			order: [layoutCssLayerName, pageCssLayerName].join(','),
			// Layers order will be exported into file with layout @layer
			exportLayer: [layoutCssLayerName],
		},
	},
	bundles: stylifyBundles,
});

// 3. Agregue un enlace que procese los archivos abiertos
/** @param { import('@stylify/bundler').BundleFileDataInterface } data */
hooks.addListener('bundler:fileToProcessOpened', (data) => {
	let { content, filePath } = data;

	// 3.1 Solo para archivos de dise√±o y p√°gina
	if (filePath.includes('/pages/') || filePath.includes('/layouts/')) {
		const cssFileName = path.parse(filePath).name;
		const cssFilePathImport = `import '/${stylesDir}/${getFileCssLayerName(
			filePath
		)}/${getOutputFileName(filePath)}';`;

		if (!content.includes(cssFilePathImport)) {
			if (/import \S+ from (?:'|")\S+(\/layouts\/\S+)(?:'|");/.test(content)) {
				content = content.replace(
					/import \S+ from (?:'|")\S+\/layouts\/\S+(?:'|");/,
					`$&\n${cssFilePathImport}`
				);
			} else if (/^\s*---\n/.test(content)) {
				content = content.replace(/^(\s*)---\n/, `$&${cssFilePathImport}\n`);
			} else {
				content = `---\n${cssFilePathImport}\n---\n${content}`;
			}

			fs.writeFileSync(filePath, content);
		}
	}

	// 3.2 Para todos los archivos
	const regExp = new RegExp(
		`import \\S+ from (?:'|")\\S+(\\/components\\/\\S+)(?:'|");`,
		'g'
	);
	let importedComponent;
	const importedComponentFiles = [];
	const rootDir = path.dirname(fileURLToPath(import.meta.url));

	while ((importedComponent = regExp.exec(content))) {
		importedComponentFiles.push(
			path.join(rootDir, 'src', importedComponent[1])
		);
	}

	data.contentOptions.files = importedComponentFiles;
});

// 4. Espere a que el paquete se inicialice y observe los directorios
// para crear nuevos paquetes cuando se agrega un archivo
hooks.addListener('bundler:initialized', ({ bundler }) => {
	// Ver dise√±os y directorios de p√°ginas
	// Si planea usar directorios anidados como blog/_slug.astro
	// para el que desea automatizar la configuraci√≥n de paquetes
	// Deber√° agregar la ruta a ellos aqu√≠
	const dirsToWatchForNewBundles = [layoutsDir, pagesDir];
	for (const dir of dirsToWatchForNewBundles) {
		fs.watch(dir, (eventType, fileName) => {
			const fileFullPath = path.join(dir, fileName);

			if (eventType !== 'rename' || !fs.existsSync(fileFullPath)) {
				return;
			}

			bundler.bundle([createBundle(fileFullPath)]);
		});
	}
});

export default {
	// 5. Agregue Stylify Astro Integration
	integrations: [stylifyIntegration]
};
```

## C√≥mo funciona
El c√≥digo anterior se divide en 5 pasos:
1. Encuentra todas las p√°ginas en `src/pages` y todos los dise√±os en `src/layouts` y llama a `createBundles` para crear la configuraci√≥n de paquetes para nosotros con el nombre de capa y el archivo de salida correctos.
2. Se inicializa la integraci√≥n de Stylify y se configura el orden de las capas CSS, por lo que generar√° el orden solo en un archivo, que tiene el nombre de capa CSS `layout`.
3. Se agrega el gancho [bundler:fileToProcessOpened](/es/docs/bundler#hooks). Este gancho tiene dos partes. Una parte est√° hecha, cuando este archivo es un dise√±o o p√°gina y la otra para cada archivo abierto.
	- Cuando se abre un dise√±o o un archivo de p√°gina, comprueba si contiene una ruta al archivo CSS y, si no, la agrega al encabezado del archivo.
	- Para todos los dem√°s archivos, intenta verificar las `importaciones`. Si se encuentra alguna importaci√≥n de componentes, la asigna como una dependencia. De esta manera, puede mapear un √°rbol de dependencia de componentes completo autom√°ticamente, de modo que solo los agregue/elimine y el CSS se genere correctamente.
4. Cuando se inicializa Bundler, podemos comenzar a buscar archivos reci√©n agregados dentro del directorio `layout` y `pages`. Cada vez que se agrega un nuevo archivo, creamos un nuevo paquete.
5. La integraci√≥n Stylify se agrega a la configuraci√≥n de Astro.

**Cuando ejecutamos el comando dev, Stylify har√° lo siguiente:**

1. Dise√±o de mapa/archivos de p√°gina
2. Genere CSS en los archivos correctos, envuelva el contenido en la capa CSS correcta y agregue enlaces a estos archivos en las plantillas de Astro.
3. Si se crea un nuevo archivo en dise√±o/p√°ginas, se agrega autom√°ticamente un nuevo paquete

**¬øY c√≥mo se ve la salida para la producci√≥n?**
Dise√±o (src/layouts/Layout.astro):
```css
@layer layout,page;
@layer layout {.b{font-size:16px}}
```

P√°gina (src/pages/index.astro):
```css
@layer page {.a{color:darkblue}}
```

## Ejemplo de integraci√≥n
Consulte el [ejemplo en Stack Blitz] interactivo (https://stackblitz.com/edit/stylify-astro-automated-bundles-example?file=src%2Fpages%2Findex.astro).

## Configuraci√≥n
Los ejemplos anteriores no incluyen todo lo que Stylify puede hacer:
- Definir [componentes](/es/docs/stylify/compiler#components)
- Agregar [selectores personalizados](/es/docs/stylify/compiler#customselectors)
- Configure [sus macros](/es/docs/stylify/compiler#macros) como `ml:20px` para margin-left
- Definir [pantallas personalizadas](/es/docs/stylify/compiler#screens)
- Puede mapear [archivos anidados](/es/docs/bundler#files-content-option) en la plantilla
- Y mucho m√°s

No dudes en [consultar los documentos](/es/docs/get-started) para obtener m√°s informaci√≥n üíé.
